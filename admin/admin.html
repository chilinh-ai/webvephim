<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WBANVE</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .sidebar {
            width: 250px;
            transition: all 0.3s;
        }
        .content {
            margin-left: 250px;
            transition: all 0.3s;
        }
        @media (max-width: 768px) {
            .sidebar {
                margin-left: -250px;
            }
            .content {
                margin-left: 0;
            }
            .sidebar.active {
                margin-left: 0;
            }
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Sidebar -->
    <div class="sidebar fixed top-0 left-0 h-full bg-gray-800 text-white">
        <div class="p-4">
            <h1 class="text-2xl font-bold mb-8">WBANVE Admin</h1>
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-300">Admin</p>
                        <p id="adminEmail" class="text-sm font-medium"></p>
                    </div>
                </div>
            </div>
            <nav>
                <ul class="space-y-2">
                    <li>
                        <a href="#dashboard" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('dashboard')">
                            <i class="fas fa-home w-6"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#movies" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('movies')">
                            <i class="fas fa-film w-6"></i>
                            <span>Quản lý phim</span>
                        </a>
                    </li>
                    <li>
                        <a href="#cinemas" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('cinemas')">
                            <i class="fas fa-building w-6"></i>
                            <span>Quản lý rạp</span>
                        </a>
                    </li>
                    <li>
                        <a href="#users" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('users')">
                            <i class="fas fa-users w-6"></i>
                            <span>Quản lý người dùng</span>
                        </a>
                    </li>
                    <li>
                        <a href="#news" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('news')">
                            <i class="fas fa-newspaper w-6"></i>
                            <span>Quản lý tin tức</span>
                        </a>
                    </li>
                    <li>
                        <a href="#bookings" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('bookings')">
                            <i class="fas fa-ticket-alt w-6"></i>
                            <span>Quản lý đặt vé</span>
                        </a>
                    </li>
                    <li>
                        <a href="#reviews" class="flex items-center p-2 hover:bg-gray-700 rounded" onclick="showSection('reviews')">
                            <i class="fas fa-comments w-6"></i>
                            <span>Quản lý đánh giá</span>
                        </a>
                    </li>
                    <li class="mt-8">
                        <a href="#" class="flex items-center p-2 hover:bg-gray-700 rounded text-red-400" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt w-6"></i>
                            <span>Đăng xuất</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content p-8">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Dashboard</h2>
                <div class="flex space-x-4">
                    <select id="timeRange" class="px-4 py-2 border rounded" onchange="updateCharts()">
                        <option value="month">Theo tháng</option>
                        <option value="quarter">Theo quý</option>
                    </select>
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        <i class="fas fa-file-excel mr-2"></i>Xuất Excel
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Movies Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 text-red-600">
                            <i class="fas fa-film text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 text-sm">Tổng số phim</h3>
                            <p class="text-2xl font-semibold" id="totalMovies">0</p>
                        </div>
                    </div>
                </div>

                <!-- Total Users Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 text-sm">Tổng số người dùng</h3>
                            <p class="text-2xl font-semibold" id="totalUsers">0</p>
                        </div>
                    </div>
                </div>

                <!-- Total Bookings Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-ticket-alt text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 text-sm">Tổng số đặt vé</h3>
                            <p class="text-2xl font-semibold" id="totalBookings">0</p>
                        </div>
                    </div>
                </div>

                <!-- Total Revenue Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-money-bill-wave text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-gray-500 text-sm">Tổng doanh thu</h3>
                            <p class="text-2xl font-semibold" id="totalRevenue">0 VNĐ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Revenue Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Doanh thu theo thời gian</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Bookings Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Số lượng đặt vé theo thời gian</h3>
                    <div class="chart-container">
                        <canvas id="bookingsChart"></canvas>
                    </div>
                </div>

                <!-- Movies Distribution Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Phân bố thể loại phim</h3>
                    <div class="chart-container">
                        <canvas id="moviesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4">Hoạt động gần đây</h3>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hoạt động</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người thực hiện</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="recentActivity">
                            <!-- Activity rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Movies Section -->
        <div id="movies" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Quản lý phim</h2>
                <button onclick="showAddMovieModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-plus mr-2"></i>Thêm phim mới
                </button>
            </div>
            <!-- Bộ lọc phim -->
            <div class="flex flex-wrap gap-4 mb-4">
                <input id="filterTitle" type="text" placeholder="Tìm theo tên phim..." class="px-4 py-2 border rounded w-64">
                <select id="filterGenre" class="px-4 py-2 border rounded w-64">
                    <option value="">Tất cả thể loại</option>
                    <option value="action">Hành động</option>
                    <option value="comedy">Hài</option>
                    <option value="drama">Tâm lý</option>
                    <option value="horror">Kinh dị</option>
                    <option value="Phim Gia Đình">Phim Gia Đình</option>
                    <option value="Phim Hài">Phim Hài</option>
                    <option value="Phim Phiêu Lưu">Phim Phiêu Lưu</option>
                    <option value="Phim Giả Tượng">Phim Giả Tượng</option>
                    <option value="Phim Chiến Tranh">Phim Chiến Tranh</option>
                    <option value="Phim Hành Động">Phim Hành Động</option>
                </select>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Poster</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên phim</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thể loại</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày khởi chiếu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="moviesList">
                        <!-- Movie rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cinemas Section -->
        <div id="cinemas" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Quản lý rạp chiếu</h2>
                <button onclick="showAddCinemaModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-plus mr-2"></i>Thêm rạp mới
                </button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hình ảnh</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên rạp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Địa chỉ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hệ thống</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiện ích</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="cinemasList">
                        <!-- Cinema rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Quản lý người dùng</h2>
                <button onclick="showAddUserModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-plus mr-2"></i>Thêm người dùng
                </button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Họ tên</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đăng ký</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vai trò</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="usersList">
                        <!-- User rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- News Section -->
        <div id="news" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Quản lý tin tức</h2>
                <button onclick="showAddNewsModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-plus mr-2"></i>Thêm tin tức
                </button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hình ảnh</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiêu đề</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Danh mục</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đăng</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lượt xem</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="newsList">
                        <!-- News rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookings" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Quản lý đặt vé</h2>
                <div class="flex space-x-4">
                    <input type="text" placeholder="Tìm kiếm..." class="px-4 py-2 border rounded">
                    <select class="px-4 py-2 border rounded">
                        <option value="">Tất cả trạng thái</option>
                        <option value="pending">Chờ xác nhận</option>
                        <option value="confirmed">Đã xác nhận</option>
                        <option value="cancelled">Đã hủy</option>
                    </select>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã đặt vé</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phim</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rạp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suất chiếu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số lượng vé</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="bookingsList">
                        <!-- Booking rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Quản lý đánh giá</h2>
                <div class="flex space-x-4">
                    <input type="text" id="filterReview" placeholder="Tìm kiếm..." class="px-4 py-2 border rounded">
                    <select id="filterSubject" class="px-4 py-2 border rounded">
                        <option value="">Tất cả chủ đề</option>
                        <option value="feedback">Phản hồi</option>
                        <option value="complaint">Khiếu nại</option>
                        <option value="suggestion">Đề xuất</option>
                    </select>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Họ tên</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số điện thoại</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chủ đề</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nội dung</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="reviewsList">
                        <!-- Review rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Movie Modal -->
    <div id="addMovieModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Thêm phim mới</h2>
                <button onclick="closeModal('addMovieModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addMovieForm" onsubmit="handleAddMovie(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên phim</label>
                        <input type="text" name="title" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngày khởi chiếu</label>
                        <input type="date" name="release_date" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thời lượng (phút)</label>
                        <input type="number" name="runtime" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thể loại</label>
                        <select multiple name="genres" required class="w-full px-3 py-2 border rounded">
                            <option value="action">Hành động</option>
                            <option value="comedy">Hài</option>
                            <option value="drama">Tâm lý</option>
                            <option value="horror">Kinh dị</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                        <textarea name="description" required class="w-full px-3 py-2 border rounded" rows="4"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Poster</label>
                        <input type="file" name="poster" accept="image/*" required class="w-full">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Trailer</label>
                        <input type="url" name="trailer" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addMovieModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Thêm phim
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Movie Modal -->
    <div id="editMovieModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Sửa thông tin phim</h2>
                <button onclick="closeModal('editMovieModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editMovieForm" onsubmit="handleEditMovie(event)">
                <input type="hidden" name="movieId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên phim</label>
                        <input type="text" name="title" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngày khởi chiếu</label>
                        <input type="date" name="release_date" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thời lượng (phút)</label>
                        <input type="number" name="runtime" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thể loại</label>
                        <select multiple name="genres" required class="w-full px-3 py-2 border rounded">
                            <option value="Phim Hành Động">Phim Hành Động</option>
                            <option value="Phim Hài">Phim Hài</option>
                            <option value="Phim Tâm Lý">Phim Tâm Lý</option>
                            <option value="Phim Kinh Dị">Phim Kinh Dị</option>
                            <option value="Phim Gia Đình">Phim Gia Đình</option>
                            <option value="Phim Phiêu Lưu">Phim Phiêu Lưu</option>
                            <option value="Phim Giả Tượng">Phim Giả Tượng</option>
                            <option value="Phim Chiến Tranh">Phim Chiến Tranh</option>
                            <option value="Phim Hoạt Hình">Phim Hoạt Hình</option>
                            <option value="Phim Lãng Mạn">Phim Lãng Mạn</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                        <textarea name="description" required class="w-full px-3 py-2 border rounded" rows="4"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Poster</label>
                        <input type="file" name="poster" accept="image/*" class="w-full">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Trailer</label>
                        <input type="url" name="trailer" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('editMovieModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Cinema Modal -->
    <div id="addCinemaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Thêm rạp chiếu mới</h2>
                <button onclick="closeModal('addCinemaModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addCinemaForm" onsubmit="handleAddCinema(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên rạp</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Địa chỉ</label>
                        <input type="text" name="address" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hệ thống</label>
                        <input type="text" name="system" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tiện ích (phân cách bằng dấu phẩy)</label>
                        <input type="text" name="amenities" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hình ảnh</label>
                        <input type="file" name="image" accept="image/*" required class="w-full">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addCinemaModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Thêm rạp
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Cinema Modal -->
    <div id="editCinemaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Sửa thông tin rạp chiếu</h2>
                <button onclick="closeModal('editCinemaModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editCinemaForm" onsubmit="handleEditCinema(event)">
                <input type="hidden" name="cinemaId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên rạp</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Địa chỉ</label>
                        <input type="text" name="address" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hệ thống</label>
                        <input type="text" name="system" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tiện ích (phân cách bằng dấu phẩy)</label>
                        <input type="text" name="amenities" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hình ảnh</label>
                        <input type="file" name="image" accept="image/*" class="w-full">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('editCinemaModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Thêm người dùng mới</h2>
                <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addUserForm" onsubmit="handleAddUser(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" name="email" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Họ tên</label>
                    <input type="text" name="name" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu</label>
                    <input type="password" name="password" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Thêm
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add News Modal -->
    <div id="addNewsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Thêm tin tức mới</h2>
                <button onclick="closeModal('addNewsModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addNewsForm" onsubmit="handleAddNews(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tiêu đề</label>
                        <input type="text" name="title" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Danh mục</label>
                        <select name="category" required class="w-full px-3 py-2 border rounded">
                            <option value="Phim ảnh">Phim ảnh</option>
                            <option value="Khuyến mãi">Khuyến mãi</option>
                            <option value="Sự kiện">Sự kiện</option>
                            <option value="Tin tức">Tin tức</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngày đăng</label>
                        <input type="date" name="date" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nội dung</label>
                        <textarea name="content" required class="w-full px-3 py-2 border rounded" rows="4"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hình ảnh</label>
                        <input type="file" name="image" accept="image/*" required class="w-full">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addNewsModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Thêm tin tức
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit News Modal -->
    <div id="editNewsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Sửa tin tức</h2>
                <button onclick="closeModal('editNewsModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editNewsForm" onsubmit="handleEditNews(event)">
                <input type="hidden" name="newsId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tiêu đề</label>
                        <input type="text" name="title" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Danh mục</label>
                        <select name="category" required class="w-full px-3 py-2 border rounded">
                            <option value="Phim ảnh">Phim ảnh</option>
                            <option value="Khuyến mãi">Khuyến mãi</option>
                            <option value="Sự kiện">Sự kiện</option>
                            <option value="Tin tức">Tin tức</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngày đăng</label>
                        <input type="date" name="date" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nội dung</label>
                        <textarea name="content" required class="w-full px-3 py-2 border rounded" rows="4"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hình ảnh</label>
                        <input type="file" name="image" accept="image/*" class="w-full">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('editNewsModal')" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Hủy
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyATE49XCQGPrrw1zst5vBihoRuu2Ak1KHs",
            authDomain: "webdatvexemphim-6f5a7.firebaseapp.com",
            projectId: "webdatvexemphim-6f5a7",
            storageBucket: "webdatvexemphim-6f5a7.firebasestorage.app",
            messagingSenderId: "463304798196",
            appId: "1:463304798196:web:4176c92111c925b1ca93a1",
            measurementId: "G-J14FBB9ZBG",
            databaseURL: "https://webdatvexemphim-6f5a7-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Check admin authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '../index.html';
            } else {
                // Kiểm tra email admin
                if (user.email === 'quantriwebvephim@gmail.com') {
                    // Hiển thị vai trò của admin
                    const adminEmail = document.getElementById('adminEmail');
                    if (adminEmail) {
                        adminEmail.innerHTML = `
                            <p class="text-sm text-gray-300">Quản trị viên</p>
                        `;
                    }
                } else {
                    // Nếu không phải email admin, hiển thị thông báo và chuyển về trang chủ
                    Swal.fire({
                        title: 'Không có quyền truy cập!',
                        text: 'Bạn không có quyền truy cập vào trang quản trị.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = '../index.html';
                    });
                }
            }
        });

        // Show section function
        window.showSection = function(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Modal functions
        window.showModal = function(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load total movies
                const moviesRef = ref(database, 'popular');
                const moviesSnapshot = await get(moviesRef);
                const movies = moviesSnapshot.val() || {};
                document.getElementById('totalMovies').textContent = Object.keys(movies).length;

                // Load total users
                const usersRef = ref(database, 'users');
                const usersSnapshot = await get(usersRef);
                const users = usersSnapshot.val() || {};
                document.getElementById('totalUsers').textContent = Object.keys(users).length;

                // Load bookings and calculate total revenue
                const bookingsRef = ref(database, 'bookings');
                const bookingsSnapshot = await get(bookingsRef);
                const bookings = bookingsSnapshot.val() || {};
                
                let totalBookings = 0;
                let totalRevenue = 0;
                let recentActivities = [];

                // Process bookings data
                Object.entries(bookings).forEach(([cinema, dates]) => {
                    Object.entries(dates).forEach(([date, showtimes]) => {
                        Object.entries(showtimes).forEach(([showtime, bookings]) => {
                            Object.entries(bookings).forEach(([bookingId, booking]) => {
                                totalBookings++;
                                if (booking.totalAmount) {
                                    totalRevenue += booking.totalAmount;
                                }

                                // Add booking activity
                                recentActivities.push({
                                    time: new Date(booking.timestamp).toLocaleString('vi-VN'),
                                    action: `Đặt vé phim "${booking.movie}"`,
                                    user: booking.booker || 'Khách',
                                    status: booking.vnpay?.vnp_TransactionStatus === '00' ? 'Đã thanh toán' : 'Chờ thanh toán'
                                });
                            });
                        });
                    });
                });

                // Update total bookings
                document.getElementById('totalBookings').textContent = totalBookings;
                
                // Update total revenue with Vietnamese currency format
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString('vi-VN') + ' VNĐ';

                // Sort activities by timestamp (newest first) and take the last 5
                recentActivities.sort((a, b) => new Date(b.time) - new Date(a.time));
                recentActivities = recentActivities.slice(0, 5);

                // Update recent activities table
                const recentActivity = document.getElementById('recentActivity');
                recentActivity.innerHTML = recentActivities.map(activity => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${activity.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${activity.status === 'Đã thanh toán' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${activity.status}
                            </span>
                        </td>
                    </tr>
                `).join('');

                // Add activity logging function
                window.logActivity = async (action, user, status) => {
                    try {
                        const activityRef = ref(database, 'activities');
                        const newActivityRef = push(activityRef);
                        await set(newActivityRef, {
                            time: new Date().toISOString(),
                            action,
                            user,
                            status
                        });
                    } catch (error) {
                        console.error('Error logging activity:', error);
                    }
                };

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể tải dữ liệu dashboard.',
                    icon: 'error'
                });
            }
        }

        // Load movies
        function loadMovies() {
            const moviesRef = ref(database, 'popular');
            onValue(moviesRef, (snapshot) => {
                const moviesObj = snapshot.val() || {};
                let moviesArr = Object.entries(moviesObj).map(([key, movie]) => ({...movie, _key: key}));

                // Lọc theo tên phim
                const filterTitle = document.getElementById('filterTitle')?.value?.toLowerCase() || '';
                if (filterTitle) {
                    moviesArr = moviesArr.filter(m => (m.title || '').toLowerCase().includes(filterTitle));
                }
                // Lọc theo thể loại
                const filterGenre = document.getElementById('filterGenre')?.value;
                if (filterGenre) {
                    moviesArr = moviesArr.filter(m => Array.isArray(m.genres) && m.genres.some(g => g.name === filterGenre || g === filterGenre));
                }

                const moviesList = document.getElementById('moviesList');
                moviesList.innerHTML = moviesArr.map(movie => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${movie.images?.poster || ''}" alt="${movie.title}" class="h-20 w-14 object-cover">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${movie.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${movie.genres?.map(g => g.name).join(', ')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${movie.release_date}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Đang chiếu
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editMovie('${movie._key}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Sửa</button>
                            <button onclick="deleteMovie('${movie._key}')" class="text-red-600 hover:text-red-900">Xóa</button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // Gắn sự kiện cho bộ lọc
        document.getElementById('filterTitle').addEventListener('input', loadMovies);
        document.getElementById('filterGenre').addEventListener('change', loadMovies);

        // Load cinemas
        function loadCinemas() {
            const cinemasRef = ref(database, 'cinemas');
            onValue(cinemasRef, (snapshot) => {
                const cinemasObj = snapshot.val() || {};
                const cinemasList = document.getElementById('cinemasList');
                
                // Chuyển đổi object thành array và thêm id vào mỗi item
                const cinemasArr = Object.entries(cinemasObj).map(([id, cinema]) => ({
                    ...cinema,
                    id: id
                }));

                cinemasList.innerHTML = cinemasArr.map(cinema => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${cinema.image}" alt="${cinema.name}" class="h-20 w-32 object-cover">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${cinema.name}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500">${cinema.address}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${cinema.system}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap gap-1">
                                ${(cinema.amenities || []).map(amenity => `
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100">${amenity}</span>
                                `).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editCinema('${cinema.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Sửa</button>
                            <button onclick="deleteCinema('${cinema.id}')" class="text-red-600 hover:text-red-900">Xóa</button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // Load users
        function loadUsers() {
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                const usersObj = snapshot.val() || {};
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = Object.entries(usersObj).map(([id, user]) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${user.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${user.name || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${user.created_at || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                ${user.status || 'Active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${user.role || 'User'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="deleteUser('${id}')" class="text-red-600 hover:text-red-900">Xóa</button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // Load news
        function loadNews() {
            const newsRef = ref(database, 'news');
            onValue(newsRef, (snapshot) => {
                const news = snapshot.val() || {};
                const newsList = document.getElementById('newsList');
                newsList.innerHTML = Object.entries(news).map(([id, item]) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${item.image}" alt="${item.title}" class="h-20 w-32 object-cover">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${item.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${item.category}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${item.date}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${item.views}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editNews('${id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Sửa</button>
                            <button onclick="deleteNews('${id}')" class="text-red-600 hover:text-red-900">Xóa</button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // Load bookings
        function loadBookings() {
            const bookingsRef = ref(database, 'bookings');
            onValue(bookingsRef, (snapshot) => {
                const bookingsObj = snapshot.val() || {};
                const bookingsList = document.getElementById('bookingsList');
                
                // Chuyển đổi dữ liệu từ cấu trúc phức tạp thành mảng phẳng
                let allBookings = [];
                Object.entries(bookingsObj).forEach(([cinema, dates]) => {
                    Object.entries(dates).forEach(([date, showtimes]) => {
                        Object.entries(showtimes).forEach(([showtime, bookings]) => {
                            Object.entries(bookings).forEach(([bookingId, booking]) => {
                                allBookings.push({
                                    id: bookingId,
                                    ...booking,
                                    cinema,
                                    date,
                                    showtime
                                });
                            });
                        });
                    });
                });

                // Sắp xếp theo thời gian đặt vé mới nhất
                allBookings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                bookingsList.innerHTML = allBookings.map(booking => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${booking.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${booking.movie}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${booking.cinema}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${booking.date} ${booking.showtime}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${booking.ticketCount} vé</div>
                            <div class="text-xs text-gray-400">Ghế: ${booking.seats?.join(', ') || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${booking.totalAmount?.toLocaleString('vi-VN')} VNĐ</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${booking.vnpay?.vnp_TransactionStatus === '00' 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-yellow-100 text-yellow-800'}">
                                ${booking.vnpay?.vnp_TransactionStatus === '00' ? 'Đã thanh toán' : 'Chờ thanh toán'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewBooking('${booking.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteBooking('${booking.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // Load reviews
        function loadReviews() {
            const reviewsRef = ref(database, 'contacts');
            onValue(reviewsRef, (snapshot) => {
                const reviewsObj = snapshot.val() || {};
                const reviewsList = document.getElementById('reviewsList');
                
                // Convert to array and sort by timestamp
                let reviewsArr = Object.entries(reviewsObj).map(([id, review]) => ({
                    id,
                    ...review,
                    timestamp: new Date(review.timestamp).toLocaleString('vi-VN')
                })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Apply filters
                const filterText = document.getElementById('filterReview')?.value?.toLowerCase() || '';
                const filterSubject = document.getElementById('filterSubject')?.value || '';

                if (filterText) {
                    reviewsArr = reviewsArr.filter(review => 
                        review.name?.toLowerCase().includes(filterText) ||
                        review.email?.toLowerCase().includes(filterText) ||
                        review.message?.toLowerCase().includes(filterText)
                    );
                }

                if (filterSubject) {
                    reviewsArr = reviewsArr.filter(review => review.subject === filterSubject);
                }

                reviewsList.innerHTML = reviewsArr.map(review => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${review.timestamp}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${review.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${review.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${review.phone}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${review.subject === 'feedback' ? 'bg-green-100 text-green-800' : 
                                  review.subject === 'complaint' ? 'bg-red-100 text-red-800' : 
                                  'bg-blue-100 text-blue-800'}">
                                ${review.subject}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500 max-w-xs truncate">${review.message}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewReview('${review.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteReview('${review.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // View review details
        window.viewReview = async (id) => {
            try {
                const reviewRef = ref(database, `contacts/${id}`);
                const snapshot = await get(reviewRef);
                const review = snapshot.val();

                if (!review) {
                    Swal.fire({
                        title: 'Không tìm thấy!',
                        text: 'Không tìm thấy thông tin đánh giá.',
                        icon: 'error'
                    });
                    return;
                }

                Swal.fire({
                    title: 'Chi tiết đánh giá',
                    html: `
                        <div class="text-left">
                            <p><strong>Thời gian:</strong> ${new Date(review.timestamp).toLocaleString('vi-VN')}</p>
                            <p><strong>Họ tên:</strong> ${review.name}</p>
                            <p><strong>Email:</strong> ${review.email}</p>
                            <p><strong>Số điện thoại:</strong> ${review.phone}</p>
                            <p><strong>Chủ đề:</strong> ${review.subject}</p>
                            <p><strong>Nội dung:</strong></p>
                            <p class="mt-2 p-4 bg-gray-50 rounded">${review.message}</p>
                        </div>
                    `,
                    width: '600px'
                });
            } catch (error) {
                console.error('Error viewing review:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xem thông tin đánh giá.',
                    icon: 'error'
                });
            }
        }

        // Delete review
        window.deleteReview = async (id) => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Bạn không thể hoàn tác sau khi xóa!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    const reviewRef = ref(database, `contacts/${id}`);
                    await remove(reviewRef);

                    Swal.fire({
                        title: 'Đã xóa!',
                        text: 'Đánh giá đã được xóa thành công.',
                        icon: 'success'
                    });
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xóa đánh giá.',
                    icon: 'error'
                });
            }
        }

        // Add event listeners for filters
        document.getElementById('filterReview')?.addEventListener('input', loadReviews);
        document.getElementById('filterSubject')?.addEventListener('change', loadReviews);

        // Initialize all data when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            loadMovies();
            loadCinemas();
            loadUsers();
            loadNews();
            loadBookings();
            loadReviews(); // Add this line
        });

        // Export functions to window object
        window.showAddMovieModal = () => showModal('addMovieModal');
        window.showAddCinemaModal = () => showModal('addCinemaModal');
        window.showAddUserModal = () => showModal('addUserModal');
        window.showAddNewsModal = () => showModal('addNewsModal');

        // Handle form submissions
        window.handleAddMovie = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const movieData = {
                    title: formData.get('title'),
                    release_date: formData.get('release_date'),
                    runtime: parseInt(formData.get('runtime')),
                    genres: Array.from(formData.getAll('genres')).map(genre => ({ name: genre })),
                    description: formData.get('description'),
                    trailer: formData.get('trailer'),
                    status: 'now_showing',
                    created_at: new Date().toISOString()
                };

                // Upload poster image if selected
                const posterFile = formData.get('poster');
                if (posterFile && posterFile.size > 0) {
                    const storageRef = ref(storage, `movies/${Date.now()}_${posterFile.name}`);
                    const snapshot = await uploadBytes(storageRef, posterFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    movieData.images = { poster: downloadURL };
                }

                const moviesRef = ref(database, 'now_showing');
                const newMovieRef = push(moviesRef);
                await set(newMovieRef, movieData);

                // Log activity
                await logActivity(
                    `Thêm phim mới: ${formData.get('title')}`,
                    'Admin',
                    'Thành công'
                );

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Phim đã được thêm thành công',
                    icon: 'success'
                });

                closeModal('addMovieModal');
                form.reset();
            } catch (error) {
                console.error('Error adding movie:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể thêm phim. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.handleEditMovie = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const movieId = formData.get('movieId');
            
            try {
                const movieData = {
                    title: formData.get('title'),
                    release_date: formData.get('release_date'),
                    runtime: parseInt(formData.get('runtime')),
                    genres: Array.from(form.genres.selectedOptions).map(option => ({ name: option.value })),
                    description: formData.get('description'),
                    trailer: formData.get('trailer'),
                    updated_at: new Date().toISOString()
                };

                // Upload new poster if selected
                const posterFile = formData.get('poster');
                if (posterFile && posterFile.size > 0) {
                    const storageRef = ref(storage, `movies/${Date.now()}_${posterFile.name}`);
                    const snapshot = await uploadBytes(storageRef, posterFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    movieData.images = { poster: downloadURL };
                }

                const movieRef = ref(database, `popular/${movieId}`);
                await update(movieRef, movieData);

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Thông tin phim đã được cập nhật',
                    icon: 'success'
                });

                closeModal('editMovieModal');
            } catch (error) {
                console.error('Error updating movie:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể cập nhật thông tin phim. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.editMovie = async (id) => {
            try {
                // Luôn lấy dữ liệu mới nhất từ node 'popular'
                const movieRef = ref(database, `popular/${id}`);
                const snapshot = await get(movieRef);
                const movie = snapshot.val();

                if (!movie) {
                    Swal.fire({
                        title: 'Không tìm thấy phim!',
                        text: 'Phim này không tồn tại hoặc đã bị xóa.',
                        icon: 'warning'
                    });
                    return;
                }

                const form = document.getElementById('editMovieForm');
                form.movieId.value = id;
                form.title.value = movie.title || '';
                form.release_date.value = movie.release_date || '';
                form.runtime.value = movie.runtime || '';
                form.description.value = movie.description || movie.overview || '';
                form.trailer.value = movie.trailer || movie.videos?.trailer || '';

                // Set selected genres (so sánh theo tên)
                const genreSelect = form.genres;
                const genres = Array.isArray(movie.genres) ? movie.genres : [];
                const selectedNames = genres.map(g => typeof g === 'string' ? g : g.name).map(name => name?.trim());
                Array.from(genreSelect.options).forEach(option => {
                    option.selected = selectedNames.includes(option.value);
                });

                showModal('editMovieModal');
            } catch (error) {
                console.error('Error loading movie:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể tải thông tin phim. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.deleteMovie = async (id) => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Bạn không thể hoàn tác sau khi xóa!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    const movieRef = ref(database, `now_showing/${id}`);
                    await remove(movieRef);

                    Swal.fire({
                        title: 'Đã xóa!',
                        text: 'Phim đã được xóa thành công.',
                        icon: 'success'
                    });
                }
            } catch (error) {
                console.error('Error deleting movie:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xóa phim. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        // Similar CRUD operations for cinemas, users, news, and bookings
        // ... Add similar functions for other entities ...

        // Booking functions
        window.viewBooking = async (id) => {
            try {
                const bookingsRef = ref(database, 'bookings');
                const snapshot = await get(bookingsRef);
                const bookingsObj = snapshot.val() || {};
                
                // Tìm booking theo ID
                let booking = null;
                Object.entries(bookingsObj).forEach(([cinema, dates]) => {
                    Object.entries(dates).forEach(([date, showtimes]) => {
                        Object.entries(showtimes).forEach(([showtime, bookings]) => {
                            if (bookings[id]) {
                                booking = {
                                    id,
                                    ...bookings[id],
                                    cinema,
                                    date,
                                    showtime
                                };
                            }
                        });
                    });
                });

                if (!booking) {
                    Swal.fire({
                        title: 'Không tìm thấy!',
                        text: 'Không tìm thấy thông tin đặt vé.',
                        icon: 'error'
                    });
                    return;
                }

                // Hiển thị thông tin chi tiết
                Swal.fire({
                    title: 'Chi tiết đặt vé',
                    html: `
                        <div class="text-left">
                            <p><strong>Mã đặt vé:</strong> ${booking.id}</p>
                            <p><strong>Phim:</strong> ${booking.movie}</p>
                            <p><strong>Rạp:</strong> ${booking.cinema}</p>
                            <p><strong>Ngày chiếu:</strong> ${booking.date}</p>
                            <p><strong>Suất chiếu:</strong> ${booking.showtime}</p>
                            <p><strong>Số lượng vé:</strong> ${booking.ticketCount}</p>
                            <p><strong>Ghế:</strong> ${booking.seats?.join(', ') || 'N/A'}</p>
                            <p><strong>Tổng tiền:</strong> ${booking.totalAmount?.toLocaleString('vi-VN')} VNĐ</p>
                            <p><strong>Người đặt:</strong> ${booking.booker}</p>
                            <p><strong>Email:</strong> ${booking.bookerEmail}</p>
                            <p><strong>Số điện thoại:</strong> ${booking.bookerPhone}</p>
                            <p><strong>Trạng thái:</strong> ${booking.vnpay?.vnp_TransactionStatus === '00' ? 'Đã thanh toán' : 'Chờ thanh toán'}</p>
                            ${booking.vnpay ? `
                                <p><strong>Mã giao dịch:</strong> ${booking.vnpay.vnp_TransactionNo}</p>
                                <p><strong>Ngân hàng:</strong> ${booking.vnpay.vnp_BankCode}</p>
                                <p><strong>Thời gian thanh toán:</strong> ${booking.vnpay.vnp_PayDate}</p>
                            ` : ''}
                        </div>
                    `,
                    width: '600px'
                });
            } catch (error) {
                console.error('Error viewing booking:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xem thông tin đặt vé.',
                    icon: 'error'
                });
            }
        }

        window.deleteBooking = async (id) => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Bạn không thể hoàn tác sau khi xóa!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    // Tìm và xóa booking
                    const bookingsRef = ref(database, 'bookings');
                    const snapshot = await get(bookingsRef);
                    const bookingsObj = snapshot.val() || {};
                    
                    let found = false;
                    Object.entries(bookingsObj).forEach(([cinema, dates]) => {
                        Object.entries(dates).forEach(([date, showtimes]) => {
                            Object.entries(showtimes).forEach(([showtime, bookings]) => {
                                if (bookings[id]) {
                                    const bookingRef = ref(database, `bookings/${cinema}/${date}/${showtime}/${id}`);
                                    remove(bookingRef);
                                    found = true;
                                }
                            });
                        });
                    });

                    if (found) {
                        Swal.fire({
                            title: 'Đã xóa!',
                            text: 'Đặt vé đã được xóa thành công.',
                            icon: 'success'
                        });
                    } else {
                        Swal.fire({
                            title: 'Không tìm thấy!',
                            text: 'Không tìm thấy thông tin đặt vé.',
                            icon: 'error'
                        });
                    }
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xóa đặt vé.',
                    icon: 'error'
                });
            }
        }

        // Cinema management functions
        window.editCinema = async (id) => {
            try {
                const cinemasRef = ref(database, 'cinemas');
                const snapshot = await get(cinemasRef);
                const cinemasObj = snapshot.val() || {};
                
                // Lấy thông tin rạp theo id
                const cinema = cinemasObj[id];

                if (cinema) {
                    const form = document.getElementById('editCinemaForm');
                    form.cinemaId.value = id;
                    form.name.value = cinema.name || '';
                    form.address.value = cinema.address || '';
                    form.system.value = cinema.system || '';
                    form.amenities.value = (cinema.amenities || []).join(', ');

                    showModal('editCinemaModal');
                } else {
                    Swal.fire({
                        title: 'Không tìm thấy rạp!',
                        text: 'Rạp này không tồn tại hoặc đã bị xóa.',
                        icon: 'warning'
                    });
                }
            } catch (error) {
                console.error('Error loading cinema:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể tải thông tin rạp chiếu. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.deleteCinema = async (id) => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Bạn không thể hoàn tác sau khi xóa!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    const cinemaRef = ref(database, `cinemas/${id}`);
                    await remove(cinemaRef);

                    Swal.fire({
                        title: 'Đã xóa!',
                        text: 'Rạp chiếu đã được xóa thành công.',
                        icon: 'success'
                    });
                }
            } catch (error) {
                console.error('Error deleting cinema:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xóa rạp chiếu. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.handleAddCinema = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const cinemaData = {
                    name: formData.get('name'),
                    address: formData.get('address'),
                    system: formData.get('system'),
                    amenities: formData.get('amenities').split(',').map(item => item.trim()),
                    created_at: new Date().toISOString()
                };

                // Upload cinema image if selected
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    const storageRef = ref(storage, `cinemas/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    cinemaData.image = downloadURL;
                }

                const cinemasRef = ref(database, 'cinemas');
                const newCinemaRef = push(cinemasRef);
                await set(newCinemaRef, cinemaData);

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Rạp chiếu đã được thêm thành công',
                    icon: 'success'
                });

                closeModal('addCinemaModal');
                form.reset();
            } catch (error) {
                console.error('Error adding cinema:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể thêm rạp chiếu. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.handleEditCinema = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const cinemaId = formData.get('cinemaId');
            
            try {
                const cinemaData = {
                    name: formData.get('name'),
                    address: formData.get('address'),
                    system: formData.get('system'),
                    amenities: formData.get('amenities').split(',').map(item => item.trim()),
                    updated_at: new Date().toISOString()
                };

                // Upload new image if selected
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    const storageRef = ref(storage, `cinemas/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    cinemaData.image = downloadURL;
                }

                const cinemaRef = ref(database, `cinemas/${cinemaId}`);
                await update(cinemaRef, cinemaData);

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Thông tin rạp chiếu đã được cập nhật',
                    icon: 'success'
                });

                closeModal('editCinemaModal');
            } catch (error) {
                console.error('Error updating cinema:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể cập nhật thông tin rạp chiếu. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.deleteUser = async (id) => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Bạn không thể hoàn tác sau khi xóa!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    const userRef = ref(database, `users/${id}`);
                    await remove(userRef);

                    Swal.fire({
                        title: 'Đã xóa!',
                        text: 'Người dùng đã được xóa thành công.',
                        icon: 'success'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xóa người dùng. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.handleAddUser = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const email = formData.get('email');
            const password = formData.get('password');
            const name = formData.get('name');
            try {
                // Tạo user trên Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Cập nhật tên hiển thị
                await updateProfile(user, { displayName: name });
                // Lưu thông tin vào Realtime Database
                const userData = {
                    email: email,
                    name: name,
                    created_at: new Date().toISOString(),
                    status: 'Active',
                    role: 'User'
                };
                await set(ref(database, `users/${user.uid}`), userData);
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Người dùng đã được tạo thành công.',
                    icon: 'success'
                });
                closeModal('addUserModal');
                form.reset();
            } catch (error) {
                console.error('Error creating user:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: error.message || 'Không thể tạo người dùng. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        // News management functions
        window.handleAddNews = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const newsData = {
                    title: formData.get('title'),
                    category: formData.get('category'),
                    date: formData.get('date'),
                    content: formData.get('content'),
                    views: 0,
                    created_at: new Date().toISOString()
                };

                // Upload image if selected
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    const storageRef = ref(storage, `news/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    newsData.image = downloadURL;
                }

                const newsRef = ref(database, 'news');
                const newNewsRef = push(newsRef);
                await set(newNewsRef, newsData);

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Tin tức đã được thêm thành công',
                    icon: 'success'
                });

                closeModal('addNewsModal');
                form.reset();
            } catch (error) {
                console.error('Error adding news:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể thêm tin tức. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.handleEditNews = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const newsId = formData.get('newsId');
            
            try {
                const newsData = {
                    title: formData.get('title'),
                    category: formData.get('category'),
                    date: formData.get('date'),
                    content: formData.get('content'),
                    updated_at: new Date().toISOString()
                };

                // Upload new image if selected
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    const storageRef = ref(storage, `news/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    newsData.image = downloadURL;
                }

                const newsRef = ref(database, `news/${newsId}`);
                await update(newsRef, newsData);

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Tin tức đã được cập nhật',
                    icon: 'success'
                });

                closeModal('editNewsModal');
            } catch (error) {
                console.error('Error updating news:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể cập nhật tin tức. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.editNews = async (id) => {
            try {
                const newsRef = ref(database, `news/${id}`);
                const snapshot = await get(newsRef);
                const news = snapshot.val();

                if (!news) {
                    Swal.fire({
                        title: 'Không tìm thấy tin tức!',
                        text: 'Tin tức này không tồn tại hoặc đã bị xóa.',
                        icon: 'warning'
                    });
                    return;
                }

                const form = document.getElementById('editNewsForm');
                form.newsId.value = id;
                form.title.value = news.title || '';
                form.category.value = news.category || '';
                form.date.value = news.date || '';
                form.content.value = news.content || '';

                showModal('editNewsModal');
            } catch (error) {
                console.error('Error loading news:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể tải thông tin tin tức. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        window.deleteNews = async (id) => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Bạn không thể hoàn tác sau khi xóa!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    const newsRef = ref(database, `news/${id}`);
                    await remove(newsRef);

                    Swal.fire({
                        title: 'Đã xóa!',
                        text: 'Tin tức đã được xóa thành công.',
                        icon: 'success'
                    });
                }
            } catch (error) {
                console.error('Error deleting news:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xóa tin tức. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }

        // Chart configurations
        let revenueChart, bookingsChart, moviesChart;

        // Initialize charts
        function initCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(75, 192, 192, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + ' VNĐ';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString('vi-VN') + ' VNĐ';
                                }
                            }
                        }
                    }
                }
            });

            // Bookings Chart
            const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
            bookingsChart = new Chart(bookingsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Số lượng đặt vé',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Movies Chart
            const moviesCtx = document.getElementById('moviesChart').getContext('2d');
            moviesChart = new Chart(moviesCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Update charts with data
        async function updateCharts() {
            const timeRange = document.getElementById('timeRange').value;
            const bookingsRef = ref(database, 'bookings');
            const moviesRef = ref(database, 'popular');

            try {
                // Get bookings data
                const bookingsSnapshot = await get(bookingsRef);
                const bookingsData = bookingsSnapshot.val() || {};
                
                // Process bookings data
                let revenueData = [];
                let bookingsCountData = [];
                let labels = [];

                // Group data by month or quarter
                const groupedData = {};
                Object.entries(bookingsData).forEach(([cinema, dates]) => {
                    Object.entries(dates).forEach(([date, showtimes]) => {
                        Object.entries(showtimes).forEach(([showtime, bookings]) => {
                            Object.entries(bookings).forEach(([bookingId, booking]) => {
                                if (booking.timestamp) {
                                    const bookingDate = new Date(booking.timestamp);
                                    const key = timeRange === 'month' 
                                        ? `${bookingDate.getFullYear()}-${String(bookingDate.getMonth() + 1).padStart(2, '0')}`
                                        : `Q${Math.floor(bookingDate.getMonth() / 3) + 1} ${bookingDate.getFullYear()}`;
                                    
                                    if (!groupedData[key]) {
                                        groupedData[key] = {
                                            revenue: 0,
                                            bookings: 0
                                        };
                                    }
                                    
                                    if (booking.totalAmount) {
                                        groupedData[key].revenue += booking.totalAmount;
                                    }
                                    groupedData[key].bookings += 1;
                                }
                            });
                        });
                    });
                });

                // Sort data by date
                const sortedKeys = Object.keys(groupedData).sort();
                labels = sortedKeys;
                revenueData = sortedKeys.map(key => groupedData[key].revenue);
                bookingsCountData = sortedKeys.map(key => groupedData[key].bookings);

                // Update revenue chart
                revenueChart.data.labels = labels;
                revenueChart.data.datasets[0].data = revenueData;
                revenueChart.update();

                // Update bookings chart
                bookingsChart.data.labels = labels;
                bookingsChart.data.datasets[0].data = bookingsCountData;
                bookingsChart.update();

                // Get movies data
                const moviesSnapshot = await get(moviesRef);
                const moviesData = moviesSnapshot.val() || {};
                
                // Process movies data
                const genreCount = {};
                Object.values(moviesData).forEach(movie => {
                    const genres = Array.isArray(movie.genres) 
                        ? movie.genres.map(g => typeof g === 'string' ? g : g.name)
                        : [];
                    genres.forEach(genre => {
                        genreCount[genre] = (genreCount[genre] || 0) + 1;
                    });
                });

                // Update movies chart
                moviesChart.data.labels = Object.keys(genreCount);
                moviesChart.data.datasets[0].data = Object.values(genreCount);
                moviesChart.update();

            } catch (error) {
                console.error('Error updating charts:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể cập nhật biểu đồ.',
                    icon: 'error'
                });
            }
        }

        // Export to Excel
        window.exportToExcel = async () => {
            try {
                const bookingsRef = ref(database, 'bookings');
                const moviesRef = ref(database, 'popular');
                const usersRef = ref(database, 'users');
                const newsRef = ref(database, 'news');
                const cinemasRef = ref(database, 'cinemas');

                // Get all data
                const [bookingsSnapshot, moviesSnapshot, usersSnapshot, newsSnapshot, cinemasSnapshot] = await Promise.all([
                    get(bookingsRef),
                    get(moviesRef),
                    get(usersRef),
                    get(newsRef),
                    get(cinemasRef)
                ]);

                const bookingsData = bookingsSnapshot.val() || {};
                const moviesData = moviesSnapshot.val() || {};
                const usersData = usersSnapshot.val() || {};
                const newsData = newsSnapshot.val() || {};
                const cinemasData = cinemasSnapshot.val() || {};

                // Prepare data for Excel
                const workbook = XLSX.utils.book_new();

                // Bookings sheet
                const bookingsSheet = [];
                Object.entries(bookingsData).forEach(([cinema, dates]) => {
                    Object.entries(dates).forEach(([date, showtimes]) => {
                        Object.entries(showtimes).forEach(([showtime, bookings]) => {
                            Object.entries(bookings).forEach(([bookingId, booking]) => {
                                bookingsSheet.push({
                                    'Mã đặt vé': bookingId,
                                    'Rạp': cinema,
                                    'Ngày': date,
                                    'Suất chiếu': showtime,
                                    'Phim': booking.movie,
                                    'Số lượng vé': booking.ticketCount,
                                    'Ghế': booking.seats?.join(', ') || 'N/A',
                                    'Tổng tiền': booking.totalAmount?.toLocaleString('vi-VN') + ' VNĐ',
                                    'Trạng thái': booking.vnpay?.vnp_TransactionStatus === '00' ? 'Đã thanh toán' : 'Chờ thanh toán',
                                    'Người đặt': booking.booker,
                                    'Email': booking.bookerEmail,
                                    'Số điện thoại': booking.bookerPhone,
                                    'Mã giao dịch': booking.vnpay?.vnp_TransactionNo || 'N/A',
                                    'Ngân hàng': booking.vnpay?.vnp_BankCode || 'N/A',
                                    'Thời gian thanh toán': booking.vnpay?.vnp_PayDate || 'N/A',
                                    'Thời gian đặt vé': new Date(booking.timestamp).toLocaleString('vi-VN')
                                });
                            });
                        });
                    });
                });

                // Movies sheet
                const moviesSheet = Object.entries(moviesData).map(([id, movie]) => ({
                    'ID': id,
                    'Tên phim': movie.title,
                    'Thể loại': Array.isArray(movie.genres) ? movie.genres.map(g => typeof g === 'string' ? g : g.name).join(', ') : '',
                    'Ngày khởi chiếu': movie.release_date,
                    'Thời lượng': movie.runtime + ' phút',
                    'Mô tả': movie.description || movie.overview,
                    'Trailer': movie.trailer || movie.videos?.trailer || 'N/A',
                    'Poster': movie.images?.poster || 'N/A',
                    'Trạng thái': movie.status || 'Đang chiếu'
                }));

                // Users sheet
                const usersSheet = Object.entries(usersData).map(([id, user]) => ({
                    'ID': id,
                    'Email': user.email,
                    'Tên': user.name,
                    'Ngày đăng ký': new Date(user.created_at).toLocaleString('vi-VN'),
                    'Trạng thái': user.status || 'Active',
                    'Vai trò': user.role || 'User'
                }));

                // News sheet
                const newsSheet = Object.entries(newsData).map(([id, news]) => ({
                    'ID': id,
                    'Tiêu đề': news.title,
                    'Danh mục': news.category,
                    'Ngày đăng': news.date,
                    'Nội dung': news.content,
                    'Lượt xem': news.views || 0,
                    'Hình ảnh': news.image || 'N/A',
                    'Thời gian tạo': new Date(news.created_at).toLocaleString('vi-VN')
                }));

                // Cinemas sheet
                const cinemasSheet = Object.entries(cinemasData).map(([id, cinema]) => ({
                    'ID': id,
                    'Tên rạp': cinema.name,
                    'Địa chỉ': cinema.address,
                    'Hệ thống': cinema.system,
                    'Tiện ích': Array.isArray(cinema.amenities) ? cinema.amenities.join(', ') : cinema.amenities,
                    'Hình ảnh': cinema.image || 'N/A',
                    'Thời gian tạo': new Date(cinema.created_at).toLocaleString('vi-VN')
                }));

                // Add sheets to workbook
                XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(bookingsSheet), 'Đặt vé');
                XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(moviesSheet), 'Phim');
                XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(usersSheet), 'Người dùng');
                XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(newsSheet), 'Tin tức');
                XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(cinemasSheet), 'Rạp chiếu');

                // Generate Excel file
                const fileName = `WBANVE_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Đã xuất file Excel thành công.',
                    icon: 'success'
                });
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể xuất file Excel.',
                    icon: 'error'
                });
            }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadDashboardData();
            updateCharts();
        });

        // Add logout function
        window.handleLogout = async () => {
            try {
                const result = await Swal.fire({
                    title: 'Xác nhận đăng xuất?',
                    text: "Bạn có chắc chắn muốn đăng xuất?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Đăng xuất',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    await auth.signOut();
                    window.location.href = '../index.html';
                }
            } catch (error) {
                console.error('Error logging out:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể đăng xuất. Vui lòng thử lại.',
                    icon: 'error'
                });
            }
        }
    </script>
</body>
</html> 